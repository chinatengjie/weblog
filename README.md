 log.py 脚本使用说明书                                       
----------------------------------------------------------------

### **脚本名称**
log.py

### **功能描述**
log.py 是一个用于分析网站日志文件的 Python 脚本，支持按用户代理（User-Agent）或 IP 地址统计流量和请求数，并生成详细的分析报告。

### **功能特点**
1. **自动检测文件编码**
   支持自动检测日志文件的编码格式（如 UTF-8、GBK 等）。

2. **多种分析模式**
   - `ua`：按用户代理（User-Agent）统计流量和请求数。
   - `ip`：按 IP 地址统计流量、请求数及主要用户代理。
   - `all`：同时统计用户代理和 IP 地址（默认模式）。

3. **限制输出条目**
   可通过 `-l` 参数限制报告中的输出条目数量。

4. **生成报告文件**
   自动生成带时间戳的报告文件，支持自定义输出目录。

### **使用方法**

#### **命令行参数**
```bash
python3 log.py <日志文件路径> [选项]
```

#### **参数说明**
| 参数               | 类型    | 默认值  | 说明                                                                 |
|--------------------|---------|---------|----------------------------------------------------------------------|
| `<日志文件路径>`    | 必填    | 无      | 需要分析的日志文件路径                                               |
| `-m, --mode`       | 字符串  | `all`   | 分析模式：`ua`（用户代理）、`ip`（IP 地址）、`all`（全部，默认）      |
| `-l, --limit`      | 整数    | `0`     | 限制输出条目数量（0 表示输出全部，默认 0）                           |
| `-f, --output-dir` | 字符串  | 无      | 指定报告输出目录（默认当前目录）                                     |

### **示例用法**

1. **分析所有日志并生成完整报告**
   ```bash
   python3 log.py access.log
   ```

2. **按用户代理分析，限制输出前 10 条**
   ```bash
   python3 log.py access.log -m ua -l 10
   ```

3. **按 IP 地址分析，并输出到指定目录**
   ```bash
   python3 log.py access.log -m ip -f ./reports
   ```

4. **仅分析用户代理，不限制条目数量**
   ```bash
   python3 log.py access.log -m ua
   ```

5. **混合使用参数**
   ```bash
   python3 log.py access.log -m ip -l 500 -f ./reports
   ```

### **输出结果**

#### **用户代理报告**（示例）
```
User-Agent流量报告
============================================================
生成时间: 2023-10-25 14:30:00
显示条目: 5/100
排名  流量占比   流量总量        请求数     User-Agent
------------------------------------------------------------------------------------------
#1   45.67%    1.23 GB         1234      Mozilla/5.0 (Windows NT 10.0; Win64; x64)
#2   30.12%    800.00 MB       987       curl/7.68.0
...
```

#### **IP 地址报告**（示例）
```
IP地址流量报告
============================================================
生成时间: 2023-10-25 14:30:00
显示条目: 5/50
排名  IP地址             流量占比   流量总量        请求数    主要User-Agent
----------------------------------------------------------------------------------------------------------
#1   192.168.1.1        60.00%    1.60 GB         1500      Mozilla/5.0 (Windows NT 10.0; Win64; x64) (500) | curl/7.68.0 (300)
#2   203.0.113.5        25.00%    666.67 MB       800       Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) (400)
...
```

### **注意事项**
1. **日志文件格式**
   脚本假设日志文件遵循常见的 Nginx/Apache 格式（如：`IP - - [时间] "请求" 状态码 字节数 "User-Agent"`）。

2. **编码检测**
   脚本会尝试检测文件编码，若检测失败，默认使用 `gbk` 编码。

3. **错误处理**
   若日志文件格式不符合预期，脚本会跳过无效行并记录异常行数。

### **依赖项**
- **Python 版本**：Python 3.x
- **第三方库**：`chardet`（用于编码检测）
  安装方法：
  ```bash
  pip3 install chardet
  ```
